Metadata-Version: 2.4
Name: eloquence-backend
Version: 0.1.0
Summary: Eloquence AI Speech Coach - Backend API
Requires-Python: >=3.11
Requires-Dist: alembic>=1.13.1
Requires-Dist: asyncpg>=0.29.0
Requires-Dist: deepgram-sdk>=0.9.0
Requires-Dist: fastapi>=0.109.0
Requires-Dist: google-genai>=0.6.0
Requires-Dist: google-generativeai>=0.8.0
Requires-Dist: groq>=0.4.0
Requires-Dist: httpx>=0.26.0
Requires-Dist: markdown>=3.6
Requires-Dist: pydantic-settings>=2.1.0
Requires-Dist: pydantic>=2.5.3
Requires-Dist: pyjwt[crypto]>=2.8.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: redis>=5.0.1
Requires-Dist: sqlalchemy[asyncio]>=2.0.25
Requires-Dist: uvicorn[standard]>=0.27.0
Requires-Dist: websockets>=12.0
Provides-Extra: dev
Requires-Dist: httpx>=0.26.0; extra == 'dev'
Requires-Dist: pytest-asyncio>=0.23.3; extra == 'dev'
Requires-Dist: pytest-cov>=4.1.0; extra == 'dev'
Requires-Dist: pytest>=7.4.4; extra == 'dev'
Requires-Dist: ruff>=0.1.14; extra == 'dev'
Description-Content-Type: text/markdown

# Eloquence Backend

Python FastAPI backend for the Eloquence AI Speech Coach.

## Quick Start

### Prerequisites

- Python 3.11+
- Docker & Docker Compose
- PostgreSQL (via Docker)
- Redis (via Docker)

### Setup

1. **Start infrastructure:**
   ```bash
   # From project root
   make dev
   ```

2. **Install Python dependencies:**
   ```bash
   cd backend
   pip install -e ".[dev]"
   ```

3. **Copy environment file:**
   ```bash
   cp ../.env.example .env
   # Edit .env with your Clerk keys
   ```

4. **Run migrations:**
   ```bash
   alembic upgrade head
   ```

5. **Start the backend:**
   ```bash
   # From project root
   make backend
   # Or directly:
   uvicorn app.main:app --reload --port 8000
   ```

6. **Verify:**
   - Health check: http://localhost:8000/health
   - API docs: http://localhost:8000/docs
   - WebSocket: ws://localhost:8000/ws

## Project Structure

```
backend/
├── app/
│   ├── main.py              # FastAPI application
│   ├── config.py            # Settings (pydantic-settings)
│   ├── database.py          # SQLAlchemy async setup
│   ├── logging_config.py    # Structured JSON logging
│   │
│   ├── models/              # SQLAlchemy ORM models
│   │   ├── user.py          # User (linked to Clerk)
│   │   ├── session.py       # Conversation sessions
│   │   ├── interaction.py   # Messages
│   │   └── observability.py # SummaryState, ProviderCalls
│   │
│   ├── auth/                # Authentication
│   │   └── clerk.py         # Clerk JWT verification
│   │
│   ├── api/
│   │   └── ws/              # WebSocket layer
│   │       ├── manager.py   # Connection manager
│   │       ├── router.py    # Message router
│   │       ├── endpoint.py  # WebSocket endpoint
│   │       └── handlers/    # Message handlers
│   │
│   └── providers/           # External service abstractions
│       ├── base.py          # Abstract interfaces
│       ├── factory.py       # Provider factory
│       └── stub.py          # Stub implementations
│
├── migrations/              # Alembic migrations
├── tests/                   # Test suite
├── pyproject.toml           # Python dependencies
└── alembic.ini              # Alembic configuration
```

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `DATABASE_URL` | PostgreSQL connection URL | Yes |
| `REDIS_URL` | Redis connection URL | Yes |
| `CLERK_PUBLISHABLE_KEY` | Clerk public key | Yes (prod) |
| `CLERK_SECRET_KEY` | Clerk secret key | Yes (prod) |
| `WORKOS_AUTH_ENABLED` | Enable WorkOS token verification (enterprise) | No |
| `WORKOS_CLIENT_ID` | WorkOS client ID (used to derive JWKS URL) | Yes (when WorkOS enabled in prod) |
| `WORKOS_API_KEY` | WorkOS API key (server-side only) | Yes (when WorkOS enabled in prod) |
| `WORKOS_ISSUER` | Expected issuer for WorkOS tokens | No |
| `WORKOS_AUDIENCE` | Optional audience (aud) to enforce for WorkOS tokens | No |
| `GROQ_API_KEY` | Groq LLM API key | No |
| `DEEPGRAM_API_KEY` | Deepgram STT API key | No |
| `GOOGLE_APPLICATION_CREDENTIALS` | Google Cloud credentials | No |
| `LOG_LEVEL` | Logging level (DEBUG, INFO, etc.) | No |
| `LOG_DEBUG_NAMESPACES` | Comma-separated debug namespaces | No |
| `PROMETHEUS_METRICS_ENABLED` | Enable `GET /metrics` Prometheus endpoint | No |
| `PROVIDER_TIMEOUT_LLM_SECONDS` | LLM non-streaming timeout (seconds) | No |
| `PROVIDER_TIMEOUT_LLM_STREAM_TTFT_SECONDS` | LLM streaming time-to-first-token timeout (seconds) | No |
| `PROVIDER_TIMEOUT_STT_SECONDS` | STT timeout (seconds) | No |
| `PROVIDER_TIMEOUT_TTS_SECONDS` | TTS timeout (seconds) | No |
| `CIRCUIT_BREAKER_FAILURE_THRESHOLD` | Observe-only breaker: failures to open circuit | No |
| `CIRCUIT_BREAKER_FAILURE_WINDOW_SECONDS` | Observe-only breaker: failure window duration (seconds) | No |
| `CIRCUIT_BREAKER_OPEN_SECONDS` | Observe-only breaker: open duration (seconds) | No |
| `CIRCUIT_BREAKER_HALF_OPEN_PROBE_COUNT` | Observe-only breaker: probe successes to close | No |
| `CONTEXT_ENRICHER_META_SUMMARY_ENABLED` | Toggle meta summary context enricher | No |
| `CONTEXT_ENRICHER_SUMMARY_ENABLED` | Toggle session summary context enricher | No |
| `CONTEXT_ENRICHER_PROFILE_ENABLED` | Toggle profile context enricher | No |
| `CONTEXT_ENRICHER_SKILLS_ENABLED` | Toggle skills context enricher | No |

## WebSocket Protocol

### Connection Flow

```
1. Client connects to ws://localhost:8000/ws
2. Client sends: { type: "auth", payload: { token: "<jwt>" } }
3. Server responds: { type: "auth.success", payload: { userId, sessionId: null, orgId?, workosOrgId? } }
4. Session is created lazily on first chat/voice message (or via explicit session.create/session.onboarding)
5. Bidirectional messaging begins
```

### Outbound Message Envelope (Centralized Projector)

All server → client WebSocket messages are routed through a centralized projector in:

- `app/api/ws/manager.py` (`ConnectionManager.send_message`)
- `app/api/ws/projector.py` (`WSMessageProjector`)

The projector enforces a consistent envelope and required metadata:

```json
{
  "type": "...",
  "payload": { "...": "..." },
  "metadata": {
    "pipeline_run_id": "<uuid>",
    "request_id": "<uuid>",
    "org_id": "<uuid>" 
  }
}
```

Notes:

- `org_id` is only present for enterprise (WorkOS) connections.
- The projector will attempt to coerce IDs from legacy shapes (e.g. `payload.requestId`, `payload.pipelineRunId`) and falls back to generating IDs if absent.

### `status.update` schema

`status.update` messages must have an object payload with the following shape:

```json
{
  "service": "stt|llm|tts|assessment|triage|summary|pipeline|...",
  "status": "started|processing|complete|error",
  "metadata": { "...": "..." }
}
```

### Enricher lifecycle events + toggles

During context build, enrichers emit durable events to `pipeline_events`:

- `enricher.<name>.started`
- `enricher.<name>.completed`

These are emitted from `app/services/chat.py` and are intended to power Central Pulse timelines.

On completion, `pipeline_events.data` includes fields like:

- `enabled` (boolean)
- `status` (`complete` | `error` | `skipped`)
- `duration_ms` (integer)
- optional `error` (string)

You can toggle enrichers with the corresponding env vars:

- `CONTEXT_ENRICHER_META_SUMMARY_ENABLED`
- `CONTEXT_ENRICHER_SUMMARY_ENABLED`
- `CONTEXT_ENRICHER_PROFILE_ENABLED`
- `CONTEXT_ENRICHER_SKILLS_ENABLED`

When an enricher is disabled, it still emits a `.completed` event with `status=skipped` and `duration_ms=0`.

### WebSocket observability metrics

When `PROMETHEUS_METRICS_ENABLED=true`, `GET /metrics` exports:

- `eloquence_ws_disconnects_total`
- `eloquence_ws_emits_total{type="..."}`
- `eloquence_ws_contract_violations_total{type="missing_chat_complete"|"duplicate_chat_complete"}`

The backend accepts either a Clerk JWT or (when enabled) a WorkOS AuthKit access token JWT. Both are normalized into a single internal identity key `(auth_provider, auth_subject)` for user lookup/creation.

## Org Tenancy (WorkOS / Enterprise)

When `WORKOS_AUTH_ENABLED=true` and a WorkOS token contains `org_id`:

- The backend upserts `Organization(workos_org_id=<org_id>)`.
- The backend ensures an `OrganizationMembership(user_id, organization_id)` exists.
- The WebSocket auth response includes:
  - `workosOrgId` (external string, e.g. `org_123`)
  - `orgId` (internal UUID)

Enterprise-only HTTP endpoints:

- `GET /api/v1/orgs/me`
- `GET /api/v1/orgs/me/memberships`

### Message Types

The protocol is implemented in `app/api/ws/handlers/*`.

#### Client → Server

| Type | Description |
|------|-------------|
| `auth` | Authenticate with a JWT (Clerk or WorkOS) |
| `ping` | Keepalive |
| `chat.message` | Text message (may trigger triage + assessment depending on pipeline mode) |
| `chat.typed` | Typed input that skips assessment by design |
| `voice.start` / `voice.chunk` / `voice.end` | Voice recording pipeline messages |
| `voice.cancel` | Cancel an active recording |
| `session.list` / `session.switch` / `session.create` / `session.rename` / `session.onboarding` | Session management |
| `skills.list` / `skills.tracked` / `skills.track` / `skills.untrack` / `skills.detail` | Skill catalog + tracking |
| `assessment.trigger` / `assessment.history` / `assessment.delete` | Manual assessment and history |
| `profile.get` / `profile.update` | Profile get/update |
| `settings.setPipelineMode` / `settings.getPipelineMode` | Per-connection pipeline mode |
| `settings.setModelChoice` / `settings.getModelChoice` | Per-connection LLM model choice |
| `feedback.message_flag` / `feedback.report` | Feedback + reporting |

#### Server → Client

| Type | Description |
|------|-------------|
| `auth.success` / `auth.error` | Auth response |
| `pong` | Keepalive response |
| `error` | Structured error message |
| `status.update` | Pipeline status events (ws/stt/llm/tts/assessment/triage/summary/etc.) |
| `session.created` / `session.list` / `session.switched` / `session.renamed` | Session events |
| `chat.token` / `chat.complete` | Streaming tokens + final assistant message |
| `voice.transcript` | STT transcript for a voice turn |
| `voice.audio.chunk` | Incremental TTS audio chunks (sentence-level) |
| `voice.audio` | Final audio payload (fallback when incremental is not used) |
| `assessment.complete` / `assessment.skipped` / `assessment.history.list` / `assessment.deleted` | Assessment events |
| `skills.catalog` / `skills.tracked.list` / `skills.track.success` / `skills.untrack.success` / `skills.detail` | Skill events |
| `skills.track.error` / `skills.untrack.error` | Skill error events (typed errors) |
| `profile.data` / `profile.updated` | Profile events |
| `settings.pipelineModeSet` / `settings.pipelineMode` | Pipeline mode events |
| `settings.modelChoiceSet` / `settings.modelChoice` | Model choice events |
| `feedback.ack` | Feedback acknowledgement |

## Admin / Observability APIs

Admin endpoints are protected by an admin allowlist and live under `/admin/*`.

Key endpoints used by Central Pulse:

- `GET /admin/stats/provider-calls`
- `GET /admin/stats/pipeline-runs`
- `GET /admin/stats/policy-denials`
- `GET /admin/stats/policy-triggers`
- `GET /admin/eval/triage/datasets` (and related triage dataset endpoints)

Tenant-scoped observability endpoints (non-admin) live under:

- `GET /api/v1/pulse/pipeline-runs`
- `GET /api/v1/pulse/pipeline-runs/{run_id}`
- `GET /api/v1/pulse/pipeline-events?pipeline_run_id=...`

## Testing

```bash
# Run all tests
make test

# Run unit tests only
make test-unit

# Run integration tests only
make test-int

# With verbose output
cd backend && pytest -xvs tests/
```

## Linting & Formatting

```bash
# Check for issues
make lint

# Auto-format
make format
```

## Database Migrations

```bash
# Apply migrations
make migrate

# Create new migration
make migrate-new MSG="add_new_table"

# Rollback one migration
cd backend && alembic downgrade -1
```

## Debugging

Enable debug logging for specific services:

```bash
# In .env
LOG_DEBUG_NAMESPACES=ws,auth,db

# Or run with:
LOG_DEBUG_NAMESPACES=ws,auth uvicorn app.main:app --reload
```

Available namespaces:
- `ws` - WebSocket events
- `auth` - Authentication
- `db` - Database operations
- `llm` - LLM provider calls
- `stt` - Speech-to-text
- `tts` - Text-to-speech
