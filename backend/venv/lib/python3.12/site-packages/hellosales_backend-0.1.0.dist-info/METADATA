Metadata-Version: 2.4
Name: hellosales-backend
Version: 0.1.0
Summary: HelloSales - Backend API
Requires-Python: >=3.11
Requires-Dist: alembic>=1.13.1
Requires-Dist: asyncpg>=0.29.0
Requires-Dist: deepgram-sdk>=0.9.0
Requires-Dist: fastapi>=0.109.0
Requires-Dist: google-genai>=0.6.0
Requires-Dist: google-generativeai>=0.8.0
Requires-Dist: groq>=0.4.0
Requires-Dist: httpx>=0.26.0
Requires-Dist: markdown>=3.6
Requires-Dist: pydantic-settings>=2.1.0
Requires-Dist: pydantic>=2.5.3
Requires-Dist: pyjwt[crypto]>=2.8.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: redis>=5.0.1
Requires-Dist: sqlalchemy[asyncio]>=2.0.25
Requires-Dist: uvicorn[standard]>=0.27.0
Requires-Dist: websockets>=12.0
Provides-Extra: dev
Requires-Dist: httpx>=0.26.0; extra == 'dev'
Requires-Dist: pytest-asyncio>=0.23.3; extra == 'dev'
Requires-Dist: pytest-cov>=4.1.0; extra == 'dev'
Requires-Dist: pytest>=7.4.4; extra == 'dev'
Requires-Dist: ruff>=0.1.14; extra == 'dev'
Description-Content-Type: text/markdown

# HelloSales Backend

Python FastAPI backend for HelloSales - Sales Management Platform.

## Enterprise Authentication

This backend uses **WorkOS** for authentication. All users must authenticate via WorkOS SSO and belong to an organization.

### Token Requirements

- **WorkOS JWT** with `org_id` claim is required
- Tokens must include organization context
- Development mode accepts `dev_token` for testing

## WorkOS SSO Setup

### 1. Create a WorkOS Account

1. Go to [WorkOS Dashboard](https://dashboard.workos.com) and sign up
2. Create a new organization in the WorkOS dashboard

### 2. Configure SSO Connection

1. In the WorkOS Dashboard, navigate to **SSO** → **Connections**
2. Click **Create Connection**
3. Fill in the connection details:
   - **Name**: Your organization name
   - **Organization ID**: This will be used as `org_id` in JWT tokens
   - **IdP Type**: Select your identity provider (Google Workspace, Okta, Azure AD, etc.)
   - **Redirect URI**: `https://your-app.com/auth/callback`

4. Copy the **Client ID** from the connection details

### 3. Get API Key

1. In the WorkOS Dashboard, navigate to **API Keys**
2. Create a new API key (or use the default one)
3. Copy the API key (you won't see it again after leaving the page)

### 4. Configure Environment Variables

```bash
# Copy the example env file
cp .env.example .env

# Edit .env with your API keys
nano .env
```

Required settings:
```env
DATABASE_URL=postgresql+asyncpg://hellosales:hellosales_dev@localhost:5432/hellosales
GROQ_API_KEY=your_groq_api_key
DEEPGRAM_API_KEY=your_deepgram_api_key
GOOGLE_API_KEY=your_google_api_key
```

### 5. Configure Identity Provider

Follow the WorkOS documentation for your specific IdP:
- [Google Workspace](https://workos.com/docs/sso/identity-providers/google)
- [Okta](https://workos.com/docs/sso/identity-providers/okta)
- [Azure AD](https://workos.com/docs/sso/identity-providers/azure-ad)
- [SAML](https://workos.com/docs/sso/identity-providers/saml)

## Quick Start

### Prerequisites

- Python 3.11+
- Docker & Docker Compose
- PostgreSQL (via Docker)
- Redis (via Docker)

### Setup

1. **Start infrastructure:**
    ```bash
    # From project root
    make up
    ```

2. **Install Python dependencies:**
    ```bash
    cd backend
    pip install -e ".[dev]"
    ```

3. **Copy environment file:**
    ```bash
    cp .env.example .env
    # Edit .env with your API keys
    ```

4. **Run migrations:**
    ```bash
    alembic upgrade head
    ```

5. **Start the backend:**
    ```bash
    uvicorn app.main:app --reload --port 8000
    ```

6. **Verify:**
    - Health check: http://localhost:8000/health
    - API docs: http://localhost:8000/docs
    - WebSocket: ws://localhost:8000/ws

## Project Structure

```
backend/
├── app/
│   ├── main.py              # FastAPI application
│   ├── config.py            # Settings (pydantic-settings)
│   ├── database.py          # SQLAlchemy async setup
│   ├── logging_config.py    # Structured JSON logging
│   │
│   ├── models/              # SQLAlchemy ORM models
│   │   ├── user.py          # User (linked to WorkOS)
│   │   ├── session.py       # Conversation sessions
│   │   ├── interaction.py   # Messages
│   │   ├── organization.py  # WorkOS organizations
│   │   └── observability.py # Pipeline runs, events
│   │
│   ├── auth/                # Authentication (WorkOS only)
│   │   ├── workos.py        # WorkOS JWT verification
│   │   └── identity.py      # Identity claims normalization
│   │
│   ├── api/
│   │   ├── http/            # HTTP REST endpoints
│   │   └── ws/              # WebSocket layer
│   │       ├── manager.py   # Connection manager
│   │       ├── router.py    # Message router
│   │       ├── endpoint.py  # WebSocket endpoint
│   │       └── handlers/    # Message handlers
│   │
│   └── ai/                  # AI pipeline processing
│       └── substrate/       # Stageflow pipeline architecture
│
├── migrations/              # Alembic migrations
├── tests/                   # Test suite
├── pyproject.toml           # Python dependencies
└── alembic.ini              # Alembic configuration
```

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `DATABASE_URL` | PostgreSQL connection URL | Yes |
| `REDIS_URL` | Redis connection URL | Yes |
| `WORKOS_CLIENT_ID` | WorkOS client ID | Yes (prod) |
| `WORKOS_API_KEY` | WorkOS API key | Yes (prod) |
| `WORKOS_ISSUER` | Expected issuer for WorkOS tokens | No |
| `WORKOS_AUDIENCE` | Optional audience (aud) to enforce | No |
| `GROQ_API_KEY` | Groq LLM API key | No |
| `DEEPGRAM_API_KEY` | Deepgram STT API key | No |
| `GOOGLE_APPLICATION_CREDENTIALS` | Google Cloud credentials | No |
| `LOG_LEVEL` | Logging level (DEBUG, INFO, etc.) | No |

## WebSocket Protocol

### Connection Flow

```
1. Client connects to ws://localhost:8000/ws
2. Client sends: { type: "auth", payload: { token: "<workos_jwt>", platform: "web" | "native" } }
3. Server responds: { type: "auth.success", payload: { userId, sessionId: null, orgId } }
4. Session is created lazily on first message
5. Bidirectional messaging begins
```

**Note:** Token must include `org_id` claim for enterprise access.

### Auth Response

```json
{
  "type": "auth.success",
  "payload": {
    "userId": "<uuid>",
    "sessionId": "<uuid> | null",
    "orgId": "<uuid>"
  }
}
```

## Enterprise Organization Tenancy

All users must belong to a WorkOS organization:

- Organization is created/linked on first authentication
- Organization membership is automatically provisioned
- All data is scoped to the user's organization
- Policy gateway enforces org_id for all operations

## Testing

```bash
# Run all tests
cd backend && pytest -xvs tests/

# Run unit tests only
cd backend && pytest -xvs tests/unit/

# Run integration tests only
cd backend && pytest -xvs tests/integration/
```

## Database Migrations

```bash
# Apply migrations
cd backend && alembic upgrade head

# Create new migration
cd backend && alembic revision -m "add_new_table"

# Rollback one migration
cd backend && alembic downgrade -1
```
